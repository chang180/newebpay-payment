# v1.0.11 ATM 轉帳顯示修正報告

## 📋 修改摘要

### 問題描述
ATM 轉帳完成取號後，回傳頁面只顯示「已收到帳單」，沒有顯示重要的繳費資訊（銀行代碼、繳費帳號），導致用戶無法完成付款。

### 修正內容

#### 1. 改善 ATM 轉帳取號成功頁面顯示 (`includes/nwp/nwpMPG.php`)

**修改位置：**
- `order_received_text()` 方法（第 305-318 行）
- `thankyou_page()` 方法（第 450-463 行）

**修正項目：**
- ✅ 將「繳費代碼」改為更清楚的「繳費帳號」
- ✅ 新增「繳費期限」顯示功能（如果有回傳 ExpireDate）
- ✅ 改善顯示邏輯，確保取號成功時正確顯示所有必要資訊

**修正前：**
```php
case 'VACC':
    if (!empty($req_data['BankCode']) && !empty($req_data['CodeNo'])) {
        $result .= '取號成功<br>';
        $result .= '銀行代碼：' . esc_attr($req_data['BankCode']) . '<br>';
        $result .= '繳費代碼：' . esc_attr($req_data['CodeNo']) . '<br>';
    }
    break;
```

**修正後：**
```php
case 'VACC':
    // ATM 轉帳取號成功時，Status 可能是 SUCCESS 或 CUSTOM
    // 只要 BankCode 和 CodeNo 存在，就表示取號成功
    if (!empty($req_data['BankCode']) && !empty($req_data['CodeNo'])) {
        $result .= '取號成功<br>';
        $result .= '銀行代碼：' . esc_attr($req_data['BankCode']) . '<br>';
        $result .= '繳費帳號：' . esc_attr($req_data['CodeNo']) . '<br>';
        if (!empty($req_data['ExpireDate'])) {
            $result .= '繳費期限：' . esc_attr($req_data['ExpireDate']) . '<br>';
        }
    }
    break;
```

#### 2. 修正訂單狀態處理邏輯 (`includes/nwp/nwpMPG.php`)

**修改位置：**
- `order_received_text()` 方法（第 371-391 行）

**問題：**
ATM 轉帳取號成功時，藍新金流回傳的 `Status` 可能是 `CUSTOM` 而不是 `SUCCESS`，導致訂單被錯誤地設為失敗狀態。

**修正項目：**
- ✅ 新增非即時付款方式的成功判斷邏輯
- ✅ ATM 轉帳、超商代碼、超商條碼取號成功時，即使 Status 不是 SUCCESS，訂單狀態也會正確設為 processing
- ✅ 避免取號成功但訂單被設為失敗的問題

**修正後邏輯：**
```php
// ATM 轉帳、超商代碼、超商條碼等非即時付款方式，取號成功時 Status 可能是 CUSTOM
// 需要特別處理這些情況
$is_vacc_success = ($req_data['PaymentType'] == 'VACC' && !empty($req_data['BankCode']) && !empty($req_data['CodeNo']));
$is_cvs_success = ($req_data['PaymentType'] == 'CVS' && !empty($req_data['CodeNo']));
$is_barcode_success = ($req_data['PaymentType'] == 'BARCODE' && (!empty($req_data['Barcode_1']) || !empty($req_data['Barcode_2']) || !empty($req_data['Barcode_3'])));

if ($req_data['Status'] != 'SUCCESS' && !$is_vacc_success && !$is_cvs_success && !$is_barcode_success) {
    // 只有真正失敗的情況才設為 failed
    $order->update_status('failed', ...);
} else {
    // 即時付款成功，或非即時付款取號成功，都將訂單設為處理中
    $order->update_status('processing');
}
```

## 🎯 修正效果

### 修正前
- ATM 轉帳取號成功後，頁面可能只顯示「已收到帳單」
- 用戶無法看到銀行代碼和繳費帳號
- 取號成功但訂單可能被設為失敗狀態

### 修正後
ATM 轉帳完成取號後，頁面會正確顯示：
- ✅ 付款方式：ATM轉帳
- ✅ 取號成功
- ✅ 銀行代碼：[銀行代碼]
- ✅ 繳費帳號：[繳費帳號]
- ✅ 繳費期限：[期限]（如果有回傳）

## 🔍 技術細節

### 藍新金流 API 回傳欄位
- `BankCode`: 銀行代碼
- `CodeNo`: 繳費帳號（虛擬帳號）
- `ExpireDate`: 繳費期限（格式：YYYYMMDD）
- `Status`: 交易狀態（SUCCESS 或 CUSTOM）

### 非即時付款方式的狀態處理
- **即時付款**（信用卡、WebATM 等）：Status = SUCCESS 表示付款成功
- **非即時付款**（ATM 轉帳、超商代碼等）：Status = CUSTOM 且相關欄位存在時，表示取號成功

## ✅ 測試建議

1. **ATM 轉帳取號測試**
   - 下單選擇 ATM 轉帳
   - 確認取號成功後頁面顯示：
     - 銀行代碼
     - 繳費帳號
     - 繳費期限（如有）
   - 確認訂單狀態為「處理中」

2. **訂單狀態驗證**
   - 確認取號成功時，訂單不會被設為失敗
   - 確認訂單狀態正確更新為 processing

## 📝 相關檔案

- `includes/nwp/nwpMPG.php` - 主要修改檔案
  - `order_received_text()` 方法
  - `thankyou_page()` 方法
  - 訂單狀態更新邏輯

## 🚀 版本資訊

- **版本**: 1.0.11
- **修正日期**: 2024
- **影響範圍**: ATM 轉帳支付方式
- **向後相容**: ✅ 是（不影響其他支付方式）

---

> 💡 **注意**: 此修正確保 ATM 轉帳用戶能夠正確看到繳費資訊，提升用戶體驗和付款成功率。
