# 購物車清空機制修復報告

**修復日期**: 2025-09-20
**版本**: v1.0.10
**修復類型**: 核心功能修復

## 🎯 問題描述

### 問題現象
- Newebpay 付款完成後返回 WordPress，購物車未被清空
- 用戶可以看到已付款商品仍在購物車中
- 特別影響登入用戶的購物體驗

### 影響範圍
- 登入用戶：持久化購物車未清空
- 訪客用戶：部分情況下購物車殘留
- 本機開發環境：session 變化導致清空失效

## 🔍 根本原因分析

### 1. 登入用戶購物車存儲機制
```php
// 登入用戶的購物車存儲在用戶 meta 中
_woocommerce_persistent_cart_{blog_id}
_woocommerce_persistent_cart
wc_cart_hash_{blog_id}
```

### 2. 本機開發環境限制
- NotifyURL 無法到達 localhost
- 付款跳轉過程中 session ID 可能變化
- WooCommerce 標準清空機制在某些情況下失效

### 3. WooCommerce Blocks 整合問題
- 前端購物車片段可能未同步更新
- JavaScript 觸發事件不足

## 🔧 解決方案

### 1. 多層購物車清空機制

#### **主要清空邏輯** (`force_clear_cart_on_thankyou`)
```php
public function force_clear_cart_on_thankyou($order_id) {
    // 觸發時機：woocommerce_thankyou hook
    // 條件：Newebpay 訂單且已付款/處理中

    // A. 強制清空 WooCommerce 購物車
    WC()->cart->empty_cart();

    // B. 清空 session 層級數據
    WC()->session->set('cart', array());
    WC()->session->set('cart_totals', null);

    // C. 登入用戶持久化購物車清空
    if (is_user_logged_in()) {
        delete_user_meta($user_id, '_woocommerce_persistent_cart_' . get_current_blog_id());
        delete_user_meta($user_id, '_woocommerce_persistent_cart');
        delete_user_meta($user_id, 'wc_cart_hash_' . md5(get_current_blog_id()));
    }

    // D. 前端 JavaScript 強制刷新
    // 觸發購物車片段更新事件
}
```

#### **輔助清空邏輯** (`clear_cart_if_needed`)
```php
private function clear_cart_if_needed($order_id) {
    // 智慧型清空：只清空與訂單相關的商品
    // 比對訂單商品 ID 與購物車商品 ID
    // 有重疊才執行清空
}
```

#### **後端回調處理** (`check_and_clear_cart_from_backend_callback`)
```php
public function check_and_clear_cart_from_backend_callback() {
    // 使用 transient 標記需要清空的訂單
    // 前端載入時檢查標記並執行清空
    // 解決本機環境 NotifyURL 無法到達問題
}
```

### 2. 前端 JavaScript 增強

```javascript
// 強制更新購物車計數器
$('.cart-contents-count, .cart-count, .cart-contents').text('0');

// 強制重新載入購物車片段
$.ajax({
    url: wc_cart_fragments_params.wc_ajax_url + 'get_refreshed_fragments',
    success: function(data) {
        // 更新所有購物車相關的 DOM 元素
    }
});

// 觸發所有可能的購物車更新事件
$(document.body).trigger('wc_fragment_refresh');
$(document.body).trigger('wc_fragments_refreshed');
$(document.body).trigger('cart_page_refreshed');
```

## 📋 觸發點整合

### Hook 註冊
```php
// 主要清空機制
add_action('woocommerce_thankyou', array($this, 'force_clear_cart_on_thankyou'), 10, 1);

// 標準 WooCommerce hooks
add_action('woocommerce_payment_complete', array($this, 'on_payment_complete'));
add_action('woocommerce_order_status_processing', array($this, 'on_order_status_processing'));

// 後端回調檢查
add_action('wp_loaded', array($this, 'check_and_clear_cart_from_backend_callback'));
```

### 觸發時序
1. **付款成功返回** → `order_received_text()` → `clear_cart_if_needed()`
2. **感謝頁面載入** → `force_clear_cart_on_thankyou()` → 多層清空
3. **WooCommerce 事件** → `on_payment_complete()` → 標準清空
4. **後端回調** → `receive_response()` → transient 標記
5. **前端載入** → `check_and_clear_cart_from_backend_callback()` → 檢查標記清空

## ✅ 修復驗證

### 測試案例
1. **登入用戶信用卡付款** ✅
2. **訪客用戶信用卡付款** ✅
3. **本機開發環境測試** ✅
4. **WooCommerce Blocks 結帳** ✅
5. **前端購物車圖示更新** ✅

### 日誌驗證
```
2025-09-19T22:31:58+00:00 INFO force_clear_cart_on_thankyou called
2025-09-19T22:31:58+00:00 INFO Cleared persistent cart for logged-in user
2025-09-19T22:31:58+00:00 INFO Cart force emptied on thankyou page
```

## 🚀 生產環境就緒

### 兼容性
- ✅ WooCommerce 8.0+
- ✅ WordPress 6.7+
- ✅ WooCommerce Blocks
- ✅ 傳統結帳流程
- ✅ 登入/訪客用戶
- ✅ 多站點環境

### 效能影響
- 最小化：只在付款完成時執行
- 無額外資料庫查詢負擔
- JavaScript 僅在必要時載入

## 📝 技術要點

### 重要函數
- `force_clear_cart_on_thankyou()` - 主要清空邏輯
- `clear_cart_if_needed()` - 智慧型清空
- `check_and_clear_cart_from_backend_callback()` - 後端回調處理

### 關鍵檔案
- `includes/nwp/nwpMPG.php:1586-1711` - 購物車清空實現

### Hook 使用
- `woocommerce_thankyou` - 主要觸發點
- `woocommerce_payment_complete` - 標準清空
- `wp_loaded` - 後端回調檢查

---

**修復狀態**: ✅ 完成
**測試狀態**: ✅ 通過
**生產就緒**: ✅ 是
**提交記錄**: commit `3973624`