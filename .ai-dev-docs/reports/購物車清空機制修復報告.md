# è³¼ç‰©è»Šæ¸…ç©ºæ©Ÿåˆ¶ä¿®å¾©å ±å‘Š

**ä¿®å¾©æ—¥æœŸ**: 2025-09-20
**ç‰ˆæœ¬**: v1.0.10
**ä¿®å¾©é¡å‹**: æ ¸å¿ƒåŠŸèƒ½ä¿®å¾©

## ğŸ¯ å•é¡Œæè¿°

### å•é¡Œç¾è±¡
- Newebpay ä»˜æ¬¾å®Œæˆå¾Œè¿”å› WordPressï¼Œè³¼ç‰©è»Šæœªè¢«æ¸…ç©º
- ç”¨æˆ¶å¯ä»¥çœ‹åˆ°å·²ä»˜æ¬¾å•†å“ä»åœ¨è³¼ç‰©è»Šä¸­
- ç‰¹åˆ¥å½±éŸ¿ç™»å…¥ç”¨æˆ¶çš„è³¼ç‰©é«”é©—

### å½±éŸ¿ç¯„åœ
- ç™»å…¥ç”¨æˆ¶ï¼šæŒä¹…åŒ–è³¼ç‰©è»Šæœªæ¸…ç©º
- è¨ªå®¢ç”¨æˆ¶ï¼šéƒ¨åˆ†æƒ…æ³ä¸‹è³¼ç‰©è»Šæ®˜ç•™
- æœ¬æ©Ÿé–‹ç™¼ç’°å¢ƒï¼šsession è®ŠåŒ–å°è‡´æ¸…ç©ºå¤±æ•ˆ

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. ç™»å…¥ç”¨æˆ¶è³¼ç‰©è»Šå­˜å„²æ©Ÿåˆ¶
```php
// ç™»å…¥ç”¨æˆ¶çš„è³¼ç‰©è»Šå­˜å„²åœ¨ç”¨æˆ¶ meta ä¸­
_woocommerce_persistent_cart_{blog_id}
_woocommerce_persistent_cart
wc_cart_hash_{blog_id}
```

### 2. æœ¬æ©Ÿé–‹ç™¼ç’°å¢ƒé™åˆ¶
- NotifyURL ç„¡æ³•åˆ°é” localhost
- ä»˜æ¬¾è·³è½‰éç¨‹ä¸­ session ID å¯èƒ½è®ŠåŒ–
- WooCommerce æ¨™æº–æ¸…ç©ºæ©Ÿåˆ¶åœ¨æŸäº›æƒ…æ³ä¸‹å¤±æ•ˆ

### 3. WooCommerce Blocks æ•´åˆå•é¡Œ
- å‰ç«¯è³¼ç‰©è»Šç‰‡æ®µå¯èƒ½æœªåŒæ­¥æ›´æ–°
- JavaScript è§¸ç™¼äº‹ä»¶ä¸è¶³

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### 1. å¤šå±¤è³¼ç‰©è»Šæ¸…ç©ºæ©Ÿåˆ¶

#### **ä¸»è¦æ¸…ç©ºé‚è¼¯** (`force_clear_cart_on_thankyou`)
```php
public function force_clear_cart_on_thankyou($order_id) {
    // è§¸ç™¼æ™‚æ©Ÿï¼šwoocommerce_thankyou hook
    // æ¢ä»¶ï¼šNewebpay è¨‚å–®ä¸”å·²ä»˜æ¬¾/è™•ç†ä¸­

    // A. å¼·åˆ¶æ¸…ç©º WooCommerce è³¼ç‰©è»Š
    WC()->cart->empty_cart();

    // B. æ¸…ç©º session å±¤ç´šæ•¸æ“š
    WC()->session->set('cart', array());
    WC()->session->set('cart_totals', null);

    // C. ç™»å…¥ç”¨æˆ¶æŒä¹…åŒ–è³¼ç‰©è»Šæ¸…ç©º
    if (is_user_logged_in()) {
        delete_user_meta($user_id, '_woocommerce_persistent_cart_' . get_current_blog_id());
        delete_user_meta($user_id, '_woocommerce_persistent_cart');
        delete_user_meta($user_id, 'wc_cart_hash_' . md5(get_current_blog_id()));
    }

    // D. å‰ç«¯ JavaScript å¼·åˆ¶åˆ·æ–°
    // è§¸ç™¼è³¼ç‰©è»Šç‰‡æ®µæ›´æ–°äº‹ä»¶
}
```

#### **è¼”åŠ©æ¸…ç©ºé‚è¼¯** (`clear_cart_if_needed`)
```php
private function clear_cart_if_needed($order_id) {
    // æ™ºæ…§å‹æ¸…ç©ºï¼šåªæ¸…ç©ºèˆ‡è¨‚å–®ç›¸é—œçš„å•†å“
    // æ¯”å°è¨‚å–®å•†å“ ID èˆ‡è³¼ç‰©è»Šå•†å“ ID
    // æœ‰é‡ç–Šæ‰åŸ·è¡Œæ¸…ç©º
}
```

#### **å¾Œç«¯å›èª¿è™•ç†** (`check_and_clear_cart_from_backend_callback`)
```php
public function check_and_clear_cart_from_backend_callback() {
    // ä½¿ç”¨ transient æ¨™è¨˜éœ€è¦æ¸…ç©ºçš„è¨‚å–®
    // å‰ç«¯è¼‰å…¥æ™‚æª¢æŸ¥æ¨™è¨˜ä¸¦åŸ·è¡Œæ¸…ç©º
    // è§£æ±ºæœ¬æ©Ÿç’°å¢ƒ NotifyURL ç„¡æ³•åˆ°é”å•é¡Œ
}
```

### 2. å‰ç«¯ JavaScript å¢å¼·

```javascript
// å¼·åˆ¶æ›´æ–°è³¼ç‰©è»Šè¨ˆæ•¸å™¨
$('.cart-contents-count, .cart-count, .cart-contents').text('0');

// å¼·åˆ¶é‡æ–°è¼‰å…¥è³¼ç‰©è»Šç‰‡æ®µ
$.ajax({
    url: wc_cart_fragments_params.wc_ajax_url + 'get_refreshed_fragments',
    success: function(data) {
        // æ›´æ–°æ‰€æœ‰è³¼ç‰©è»Šç›¸é—œçš„ DOM å…ƒç´ 
    }
});

// è§¸ç™¼æ‰€æœ‰å¯èƒ½çš„è³¼ç‰©è»Šæ›´æ–°äº‹ä»¶
$(document.body).trigger('wc_fragment_refresh');
$(document.body).trigger('wc_fragments_refreshed');
$(document.body).trigger('cart_page_refreshed');
```

## ğŸ“‹ è§¸ç™¼é»æ•´åˆ

### Hook è¨»å†Š
```php
// ä¸»è¦æ¸…ç©ºæ©Ÿåˆ¶
add_action('woocommerce_thankyou', array($this, 'force_clear_cart_on_thankyou'), 10, 1);

// æ¨™æº– WooCommerce hooks
add_action('woocommerce_payment_complete', array($this, 'on_payment_complete'));
add_action('woocommerce_order_status_processing', array($this, 'on_order_status_processing'));

// å¾Œç«¯å›èª¿æª¢æŸ¥
add_action('wp_loaded', array($this, 'check_and_clear_cart_from_backend_callback'));
```

### è§¸ç™¼æ™‚åº
1. **ä»˜æ¬¾æˆåŠŸè¿”å›** â†’ `order_received_text()` â†’ `clear_cart_if_needed()`
2. **æ„Ÿè¬é é¢è¼‰å…¥** â†’ `force_clear_cart_on_thankyou()` â†’ å¤šå±¤æ¸…ç©º
3. **WooCommerce äº‹ä»¶** â†’ `on_payment_complete()` â†’ æ¨™æº–æ¸…ç©º
4. **å¾Œç«¯å›èª¿** â†’ `receive_response()` â†’ transient æ¨™è¨˜
5. **å‰ç«¯è¼‰å…¥** â†’ `check_and_clear_cart_from_backend_callback()` â†’ æª¢æŸ¥æ¨™è¨˜æ¸…ç©º

## âœ… ä¿®å¾©é©—è­‰

### æ¸¬è©¦æ¡ˆä¾‹
1. **ç™»å…¥ç”¨æˆ¶ä¿¡ç”¨å¡ä»˜æ¬¾** âœ…
2. **è¨ªå®¢ç”¨æˆ¶ä¿¡ç”¨å¡ä»˜æ¬¾** âœ…
3. **æœ¬æ©Ÿé–‹ç™¼ç’°å¢ƒæ¸¬è©¦** âœ…
4. **WooCommerce Blocks çµå¸³** âœ…
5. **å‰ç«¯è³¼ç‰©è»Šåœ–ç¤ºæ›´æ–°** âœ…

### æ—¥èªŒé©—è­‰
```
2025-09-19T22:31:58+00:00 INFO force_clear_cart_on_thankyou called
2025-09-19T22:31:58+00:00 INFO Cleared persistent cart for logged-in user
2025-09-19T22:31:58+00:00 INFO Cart force emptied on thankyou page
```

## ğŸš€ ç”Ÿç”¢ç’°å¢ƒå°±ç·’

### å…¼å®¹æ€§
- âœ… WooCommerce 8.0+
- âœ… WordPress 6.7+
- âœ… WooCommerce Blocks
- âœ… å‚³çµ±çµå¸³æµç¨‹
- âœ… ç™»å…¥/è¨ªå®¢ç”¨æˆ¶
- âœ… å¤šç«™é»ç’°å¢ƒ

### æ•ˆèƒ½å½±éŸ¿
- æœ€å°åŒ–ï¼šåªåœ¨ä»˜æ¬¾å®Œæˆæ™‚åŸ·è¡Œ
- ç„¡é¡å¤–è³‡æ–™åº«æŸ¥è©¢è² æ“”
- JavaScript åƒ…åœ¨å¿…è¦æ™‚è¼‰å…¥

## ğŸ“ æŠ€è¡“è¦é»

### é‡è¦å‡½æ•¸
- `force_clear_cart_on_thankyou()` - ä¸»è¦æ¸…ç©ºé‚è¼¯
- `clear_cart_if_needed()` - æ™ºæ…§å‹æ¸…ç©º
- `check_and_clear_cart_from_backend_callback()` - å¾Œç«¯å›èª¿è™•ç†

### é—œéµæª”æ¡ˆ
- `includes/nwp/nwpMPG.php:1586-1711` - è³¼ç‰©è»Šæ¸…ç©ºå¯¦ç¾

### Hook ä½¿ç”¨
- `woocommerce_thankyou` - ä¸»è¦è§¸ç™¼é»
- `woocommerce_payment_complete` - æ¨™æº–æ¸…ç©º
- `wp_loaded` - å¾Œç«¯å›èª¿æª¢æŸ¥

---

**ä¿®å¾©ç‹€æ…‹**: âœ… å®Œæˆ
**æ¸¬è©¦ç‹€æ…‹**: âœ… é€šé
**ç”Ÿç”¢å°±ç·’**: âœ… æ˜¯
**æäº¤è¨˜éŒ„**: commit `3973624`