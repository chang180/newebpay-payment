# v1.0.10 Block Display 技術規範文件

> 🔧 **技術文件**: 詳細的實作規範和代碼結構定義

## 📋 總體技術架構

### 設計原則
1. **模組化設計** - 區塊功能獨立模組，不影響現有架構
2. **向後相容** - 保持與傳統 shortcode 和 widget 的相容性
3. **效能優先** - 按需載入，避免不必要的資源消耗
4. **安全第一** - 所有輸入驗證，適當的權限控制

### 技術棧選擇
- **前端框架**: React (WordPress 標準)
- **建置工具**: @wordpress/scripts
- **樣式系統**: CSS + WordPress Block 標準
- **狀態管理**: WordPress Block Editor 原生 API
- **API 通訊**: WordPress REST API + 現有 AJAX

## 🏗️ 檔案結構規範

```
includes/blocks/
├── class-newebpay-blocks.php              # 主要管理類別
├── blocks/                                # 個別區塊定義
│   ├── payment-methods/                   # 付款方式選擇區塊
│   │   ├── block.json                     # 區塊定義檔
│   │   ├── index.php                      # PHP 註冊邏輯
│   │   ├── edit.js                        # 編輯器介面
│   │   ├── save.js                        # 前端保存邏輯
│   │   └── style.css                      # 區塊樣式
│   ├── payment-status/                    # 付款狀態區塊
│   ├── invoice-settings/                  # 電子發票設定區塊
│   └── transaction-history/               # 交易歷史區塊
├── assets/                                # 共用資源
│   ├── js/
│   │   ├── blocks-editor.js               # 編輯器共用腳本
│   │   ├── blocks-frontend.js             # 前端共用腳本
│   │   └── blocks-admin.js                # 後台管理腳本
│   └── css/
│       ├── blocks-editor.css              # 編輯器樣式
│       ├── blocks-frontend.css            # 前端樣式
│       └── blocks-admin.css               # 後台樣式
└── build/                                 # 編譯後檔案 (自動生成)
    ├── payment-methods.js
    ├── payment-status.js
    └── ...
```

## 🔧 核心類別設計

### class-newebpay-blocks.php 規範

```php
<?php
/**
 * Newebpay Blocks 管理類別
 * 
 * @package NewebpayPayment
 * @subpackage Blocks
 * @since 1.0.10
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Newebpay_Blocks {
    
    /**
     * 單例實例
     */
    private static $instance = null;
    
    /**
     * 區塊列表
     */
    private $blocks = array();
    
    /**
     * 取得單例實例
     */
    public static function get_instance() {
        if ( null === self::$instance ) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    /**
     * 建構函式
     */
    private function __construct() {
        $this->init_hooks();
        $this->register_blocks();
    }
    
    /**
     * 初始化 Hooks
     */
    private function init_hooks() {
        add_action( 'init', array( $this, 'register_block_types' ) );
        add_action( 'enqueue_block_editor_assets', array( $this, 'enqueue_block_editor_assets' ) );
        add_action( 'wp_enqueue_scripts', array( $this, 'enqueue_block_assets' ) );
    }
    
    /**
     * 註冊區塊類型
     */
    public function register_block_types() {
        // 實作區塊註冊邏輯
    }
    
    /**
     * 載入編輯器資源
     */
    public function enqueue_block_editor_assets() {
        // 實作編輯器資源載入
    }
    
    /**
     * 載入前端資源
     */
    public function enqueue_block_assets() {
        // 實作前端資源載入
    }
}
```

## 💳 付款方式區塊規範

### block.json 定義
```json
{
    "apiVersion": 2,
    "name": "newebpay/payment-methods",
    "version": "1.0.10",
    "title": "Newebpay 付款方式",
    "category": "newebpay",
    "icon": "money-alt",
    "description": "顯示 Newebpay 支援的付款方式選擇",
    "keywords": ["payment", "newebpay", "付款"],
    "supports": {
        "html": false,
        "align": ["wide", "full"],
        "spacing": {
            "margin": true,
            "padding": true
        }
    },
    "attributes": {
        "showMethods": {
            "type": "array",
            "default": []
        },
        "layout": {
            "type": "string",
            "default": "grid"
        },
        "showDescriptions": {
            "type": "boolean",
            "default": true
        }
    },
    "textdomain": "newebpay-payment",
    "editorScript": "file:./index.js",
    "editorStyle": "file:./index.css",
    "style": "file:./style-index.css"
}
```

### React 組件結構

#### edit.js (編輯器介面)
```javascript
import { __ } from '@wordpress/i18n';
import { InspectorControls, useBlockProps } from '@wordpress/block-editor';
import { PanelBody, ToggleControl, SelectControl } from '@wordpress/components';

export default function Edit({ attributes, setAttributes }) {
    const { showMethods, layout, showDescriptions } = attributes;
    
    const blockProps = useBlockProps();
    
    return (
        <>
            <InspectorControls>
                <PanelBody title={__('付款方式設定', 'newebpay-payment')}>
                    {/* 設定控制項 */}
                </PanelBody>
            </InspectorControls>
            <div {...blockProps}>
                {/* 編輯器預覽內容 */}
            </div>
        </>
    );
}
```

#### save.js (前端保存)
```javascript
import { useBlockProps } from '@wordpress/block-editor';

export default function Save({ attributes }) {
    const blockProps = useBlockProps.save();
    
    return (
        <div {...blockProps}>
            {/* 前端顯示內容 - 可能為空，使用 PHP render */}
        </div>
    );
}
```

## 🔗 與現有系統整合

### 與 nwpMPG.php 整合
```php
/**
 * 在區塊中整合現有付款邏輯
 */
class Newebpay_Payment_Methods_Block {
    
    public function render_callback( $attributes, $content ) {
        // 取得現有的付款方式設定
        $nwp_settings = get_option( 'woocommerce_nwp_settings' );
        $available_methods = $this->get_available_payment_methods( $nwp_settings );
        
        // 根據區塊設定篩選要顯示的方式
        $show_methods = $attributes['showMethods'] ?? array();
        $filtered_methods = $this->filter_methods( $available_methods, $show_methods );
        
        // 生成 HTML 輸出
        return $this->generate_payment_methods_html( $filtered_methods, $attributes );
    }
    
    private function get_available_payment_methods( $settings ) {
        // 利用現有的設定邏輯判斷可用付款方式
        $methods = array();
        
        if ( $settings['credit'] === 'yes' ) {
            $methods['credit'] = array(
                'name' => __( '信用卡', 'newebpay-payment' ),
                'description' => __( '支援各大銀行信用卡', 'newebpay-payment' ),
                'icon' => 'credit-card'
            );
        }
        
        // 其他付款方式...
        
        return $methods;
    }
}
```

### 與 nwpElectronicInvoice.php 整合
```php
/**
 * 電子發票區塊整合
 */
class Newebpay_Invoice_Block {
    
    public function render_callback( $attributes, $content ) {
        // 檢查電子發票功能是否啟用
        if ( ! $this->is_invoice_enabled() ) {
            return '';
        }
        
        // 取得發票設定
        $invoice_instance = nwpElectronicInvoice::get_instance();
        $invoice_settings = $invoice_instance->get_settings();
        
        // 根據使用者狀態顯示不同內容
        if ( is_user_logged_in() ) {
            return $this->render_invoice_form( $attributes, $invoice_settings );
        } else {
            return $this->render_login_prompt( $attributes );
        }
    }
}
```

## 🎨 樣式系統規範

### CSS 架構
```css
/* 區塊命名空間 */
.wp-block-newebpay-payment-methods {
    /* 基礎區塊樣式 */
}

/* 佈局變體 */
.wp-block-newebpay-payment-methods.is-layout-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.wp-block-newebpay-payment-methods.is-layout-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

/* 付款方式項目 */
.newebpay-payment-method {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.newebpay-payment-method:hover {
    border-color: #007cba;
    box-shadow: 0 2px 8px rgba(0, 124, 186, 0.1);
}

/* 響應式設計 */
@media (max-width: 768px) {
    .wp-block-newebpay-payment-methods.is-layout-grid {
        grid-template-columns: 1fr;
    }
}
```

### 主題相容性
```css
/* 適應不同主題的變數 */
.wp-block-newebpay-payment-methods {
    --newebpay-primary-color: var(--wp--preset--color--primary, #007cba);
    --newebpay-secondary-color: var(--wp--preset--color--secondary, #666);
    --newebpay-border-radius: var(--wp--preset--border-radius--medium, 4px);
}
```

## 📡 API 整合規範

### REST API 端點
```php
/**
 * 註冊自定義 REST API 端點
 */
class Newebpay_Blocks_API {
    
    public function register_routes() {
        register_rest_route( 'newebpay/v1', '/payment-methods', array(
            'methods' => 'GET',
            'callback' => array( $this, 'get_payment_methods' ),
            'permission_callback' => array( $this, 'check_permissions' )
        ) );
        
        register_rest_route( 'newebpay/v1', '/payment-status/(?P<order_id>\d+)', array(
            'methods' => 'GET',
            'callback' => array( $this, 'get_payment_status' ),
            'permission_callback' => array( $this, 'check_order_permissions' )
        ) );
    }
    
    public function get_payment_methods( $request ) {
        // 回傳可用的付款方式
        $methods = $this->get_available_methods();
        return new WP_REST_Response( $methods, 200 );
    }
}
```

### AJAX 處理
```javascript
// 前端 AJAX 請求範例
const fetchPaymentMethods = async () => {
    try {
        const response = await fetch('/wp-json/newebpay/v1/payment-methods', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-WP-Nonce': newebpayBlocks.nonce
            }
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Error fetching payment methods:', error);
        return [];
    }
};
```

## 🧪 測試規範

### 單元測試結構
```php
/**
 * 區塊功能測試類別
 */
class Test_Newebpay_Blocks extends WP_UnitTestCase {
    
    public function setUp() {
        parent::setUp();
        $this->blocks_instance = Newebpay_Blocks::get_instance();
    }
    
    public function test_blocks_registration() {
        // 測試區塊註冊
        $this->assertTrue( $this->blocks_instance->is_block_registered( 'newebpay/payment-methods' ) );
    }
    
    public function test_payment_methods_rendering() {
        // 測試付款方式區塊渲染
        $attributes = array( 'showMethods' => array( 'credit', 'atm' ) );
        $output = $this->blocks_instance->render_payment_methods( $attributes );
        
        $this->assertContains( 'credit', $output );
        $this->assertContains( 'atm', $output );
    }
}
```

### 前端測試
```javascript
// Jest 測試範例
import { render, screen } from '@testing-library/react';
import PaymentMethodsEdit from '../payment-methods/edit';

describe('PaymentMethodsEdit', () => {
    it('renders payment methods correctly', () => {
        const attributes = {
            showMethods: ['credit', 'atm'],
            layout: 'grid'
        };
        
        render(<PaymentMethodsEdit attributes={attributes} setAttributes={jest.fn()} />);
        
        expect(screen.getByText('信用卡')).toBeInTheDocument();
        expect(screen.getByText('ATM')).toBeInTheDocument();
    });
});
```

## 🔒 安全性規範

### 輸入驗證
```php
/**
 * 區塊屬性驗證
 */
class Newebpay_Blocks_Validator {
    
    public function validate_payment_methods_attributes( $attributes ) {
        $validated = array();
        
        // 驗證 showMethods
        if ( isset( $attributes['showMethods'] ) && is_array( $attributes['showMethods'] ) ) {
            $allowed_methods = $this->get_allowed_payment_methods();
            $validated['showMethods'] = array_intersect( $attributes['showMethods'], $allowed_methods );
        }
        
        // 驗證 layout
        if ( isset( $attributes['layout'] ) ) {
            $allowed_layouts = array( 'grid', 'list', 'inline' );
            $validated['layout'] = in_array( $attributes['layout'], $allowed_layouts ) 
                ? $attributes['layout'] 
                : 'grid';
        }
        
        return $validated;
    }
}
```

### 權限控制
```php
/**
 * 區塊權限檢查
 */
public function check_block_permissions( $block_name ) {
    // 檢查用戶是否有使用區塊的權限
    if ( ! current_user_can( 'edit_posts' ) ) {
        return false;
    }
    
    // 特定區塊的額外權限檢查
    switch ( $block_name ) {
        case 'newebpay/payment-methods':
            return current_user_can( 'manage_woocommerce' );
        case 'newebpay/transaction-history':
            return is_user_logged_in();
        default:
            return true;
    }
}
```

## 📊 效能優化規範

### 資源載入策略
```php
/**
 * 條件式資源載入
 */
public function enqueue_block_assets() {
    // 只在有使用區塊的頁面載入資源
    if ( has_block( 'newebpay/payment-methods' ) ) {
        wp_enqueue_script( 'newebpay-payment-methods' );
        wp_enqueue_style( 'newebpay-payment-methods' );
    }
    
    if ( has_block( 'newebpay/payment-status' ) ) {
        wp_enqueue_script( 'newebpay-payment-status' );
    }
}
```

### 快取機制
```php
/**
 * 區塊輸出快取
 */
public function render_with_cache( $attributes, $content, $block ) {
    $cache_key = 'newebpay_block_' . md5( serialize( $attributes ) );
    $cached_output = wp_cache_get( $cache_key, 'newebpay_blocks' );
    
    if ( false === $cached_output ) {
        $cached_output = $this->render_block_content( $attributes, $content, $block );
        wp_cache_set( $cache_key, $cached_output, 'newebpay_blocks', HOUR_IN_SECONDS );
    }
    
    return $cached_output;
}
```

---

**文件狀態**: 📋 技術規範完成  
**適用版本**: v1.0.10  
**最後更新**: 2025年8月30日
