# v1.0.10 Block Display æŠ€è¡“è¦ç¯„æ–‡ä»¶

> ğŸ”§ **æŠ€è¡“æ–‡ä»¶**: è©³ç´°çš„å¯¦ä½œè¦ç¯„å’Œä»£ç¢¼çµæ§‹å®šç¾©

## ğŸ“‹ ç¸½é«”æŠ€è¡“æ¶æ§‹

### è¨­è¨ˆåŸå‰‡
1. **æ¨¡çµ„åŒ–è¨­è¨ˆ** - å€å¡ŠåŠŸèƒ½ç¨ç«‹æ¨¡çµ„ï¼Œä¸å½±éŸ¿ç¾æœ‰æ¶æ§‹
2. **å‘å¾Œç›¸å®¹** - ä¿æŒèˆ‡å‚³çµ± shortcode å’Œ widget çš„ç›¸å®¹æ€§
3. **æ•ˆèƒ½å„ªå…ˆ** - æŒ‰éœ€è¼‰å…¥ï¼Œé¿å…ä¸å¿…è¦çš„è³‡æºæ¶ˆè€—
4. **å®‰å…¨ç¬¬ä¸€** - æ‰€æœ‰è¼¸å…¥é©—è­‰ï¼Œé©ç•¶çš„æ¬Šé™æ§åˆ¶

### æŠ€è¡“æ£§é¸æ“‡
- **å‰ç«¯æ¡†æ¶**: React (WordPress æ¨™æº–)
- **å»ºç½®å·¥å…·**: @wordpress/scripts
- **æ¨£å¼ç³»çµ±**: CSS + WordPress Block æ¨™æº–
- **ç‹€æ…‹ç®¡ç†**: WordPress Block Editor åŸç”Ÿ API
- **API é€šè¨Š**: WordPress REST API + ç¾æœ‰ AJAX

## ğŸ—ï¸ æª”æ¡ˆçµæ§‹è¦ç¯„

```
includes/blocks/
â”œâ”€â”€ class-newebpay-blocks.php              # ä¸»è¦ç®¡ç†é¡åˆ¥
â”œâ”€â”€ blocks/                                # å€‹åˆ¥å€å¡Šå®šç¾©
â”‚   â”œâ”€â”€ payment-methods/                   # ä»˜æ¬¾æ–¹å¼é¸æ“‡å€å¡Š
â”‚   â”‚   â”œâ”€â”€ block.json                     # å€å¡Šå®šç¾©æª”
â”‚   â”‚   â”œâ”€â”€ index.php                      # PHP è¨»å†Šé‚è¼¯
â”‚   â”‚   â”œâ”€â”€ edit.js                        # ç·¨è¼¯å™¨ä»‹é¢
â”‚   â”‚   â”œâ”€â”€ save.js                        # å‰ç«¯ä¿å­˜é‚è¼¯
â”‚   â”‚   â””â”€â”€ style.css                      # å€å¡Šæ¨£å¼
â”‚   â”œâ”€â”€ payment-status/                    # ä»˜æ¬¾ç‹€æ…‹å€å¡Š
â”‚   â”œâ”€â”€ invoice-settings/                  # é›»å­ç™¼ç¥¨è¨­å®šå€å¡Š
â”‚   â””â”€â”€ transaction-history/               # äº¤æ˜“æ­·å²å€å¡Š
â”œâ”€â”€ assets/                                # å…±ç”¨è³‡æº
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ blocks-editor.js               # ç·¨è¼¯å™¨å…±ç”¨è…³æœ¬
â”‚   â”‚   â”œâ”€â”€ blocks-frontend.js             # å‰ç«¯å…±ç”¨è…³æœ¬
â”‚   â”‚   â””â”€â”€ blocks-admin.js                # å¾Œå°ç®¡ç†è…³æœ¬
â”‚   â””â”€â”€ css/
â”‚       â”œâ”€â”€ blocks-editor.css              # ç·¨è¼¯å™¨æ¨£å¼
â”‚       â”œâ”€â”€ blocks-frontend.css            # å‰ç«¯æ¨£å¼
â”‚       â””â”€â”€ blocks-admin.css               # å¾Œå°æ¨£å¼
â””â”€â”€ build/                                 # ç·¨è­¯å¾Œæª”æ¡ˆ (è‡ªå‹•ç”Ÿæˆ)
    â”œâ”€â”€ payment-methods.js
    â”œâ”€â”€ payment-status.js
    â””â”€â”€ ...
```

## ğŸ”§ æ ¸å¿ƒé¡åˆ¥è¨­è¨ˆ

### class-newebpay-blocks.php è¦ç¯„

```php
<?php
/**
 * Newebpay Blocks ç®¡ç†é¡åˆ¥
 * 
 * @package NewebpayPayment
 * @subpackage Blocks
 * @since 1.0.10
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Newebpay_Blocks {
    
    /**
     * å–®ä¾‹å¯¦ä¾‹
     */
    private static $instance = null;
    
    /**
     * å€å¡Šåˆ—è¡¨
     */
    private $blocks = array();
    
    /**
     * å–å¾—å–®ä¾‹å¯¦ä¾‹
     */
    public static function get_instance() {
        if ( null === self::$instance ) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    /**
     * å»ºæ§‹å‡½å¼
     */
    private function __construct() {
        $this->init_hooks();
        $this->register_blocks();
    }
    
    /**
     * åˆå§‹åŒ– Hooks
     */
    private function init_hooks() {
        add_action( 'init', array( $this, 'register_block_types' ) );
        add_action( 'enqueue_block_editor_assets', array( $this, 'enqueue_block_editor_assets' ) );
        add_action( 'wp_enqueue_scripts', array( $this, 'enqueue_block_assets' ) );
    }
    
    /**
     * è¨»å†Šå€å¡Šé¡å‹
     */
    public function register_block_types() {
        // å¯¦ä½œå€å¡Šè¨»å†Šé‚è¼¯
    }
    
    /**
     * è¼‰å…¥ç·¨è¼¯å™¨è³‡æº
     */
    public function enqueue_block_editor_assets() {
        // å¯¦ä½œç·¨è¼¯å™¨è³‡æºè¼‰å…¥
    }
    
    /**
     * è¼‰å…¥å‰ç«¯è³‡æº
     */
    public function enqueue_block_assets() {
        // å¯¦ä½œå‰ç«¯è³‡æºè¼‰å…¥
    }
}
```

## ğŸ’³ ä»˜æ¬¾æ–¹å¼å€å¡Šè¦ç¯„

### block.json å®šç¾©
```json
{
    "apiVersion": 2,
    "name": "newebpay/payment-methods",
    "version": "1.0.10",
    "title": "Newebpay ä»˜æ¬¾æ–¹å¼",
    "category": "newebpay",
    "icon": "money-alt",
    "description": "é¡¯ç¤º Newebpay æ”¯æ´çš„ä»˜æ¬¾æ–¹å¼é¸æ“‡",
    "keywords": ["payment", "newebpay", "ä»˜æ¬¾"],
    "supports": {
        "html": false,
        "align": ["wide", "full"],
        "spacing": {
            "margin": true,
            "padding": true
        }
    },
    "attributes": {
        "showMethods": {
            "type": "array",
            "default": []
        },
        "layout": {
            "type": "string",
            "default": "grid"
        },
        "showDescriptions": {
            "type": "boolean",
            "default": true
        }
    },
    "textdomain": "newebpay-payment",
    "editorScript": "file:./index.js",
    "editorStyle": "file:./index.css",
    "style": "file:./style-index.css"
}
```

### React çµ„ä»¶çµæ§‹

#### edit.js (ç·¨è¼¯å™¨ä»‹é¢)
```javascript
import { __ } from '@wordpress/i18n';
import { InspectorControls, useBlockProps } from '@wordpress/block-editor';
import { PanelBody, ToggleControl, SelectControl } from '@wordpress/components';

export default function Edit({ attributes, setAttributes }) {
    const { showMethods, layout, showDescriptions } = attributes;
    
    const blockProps = useBlockProps();
    
    return (
        <>
            <InspectorControls>
                <PanelBody title={__('ä»˜æ¬¾æ–¹å¼è¨­å®š', 'newebpay-payment')}>
                    {/* è¨­å®šæ§åˆ¶é … */}
                </PanelBody>
            </InspectorControls>
            <div {...blockProps}>
                {/* ç·¨è¼¯å™¨é è¦½å…§å®¹ */}
            </div>
        </>
    );
}
```

#### save.js (å‰ç«¯ä¿å­˜)
```javascript
import { useBlockProps } from '@wordpress/block-editor';

export default function Save({ attributes }) {
    const blockProps = useBlockProps.save();
    
    return (
        <div {...blockProps}>
            {/* å‰ç«¯é¡¯ç¤ºå…§å®¹ - å¯èƒ½ç‚ºç©ºï¼Œä½¿ç”¨ PHP render */}
        </div>
    );
}
```

## ğŸ”— èˆ‡ç¾æœ‰ç³»çµ±æ•´åˆ

### èˆ‡ nwpMPG.php æ•´åˆ
```php
/**
 * åœ¨å€å¡Šä¸­æ•´åˆç¾æœ‰ä»˜æ¬¾é‚è¼¯
 */
class Newebpay_Payment_Methods_Block {
    
    public function render_callback( $attributes, $content ) {
        // å–å¾—ç¾æœ‰çš„ä»˜æ¬¾æ–¹å¼è¨­å®š
        $nwp_settings = get_option( 'woocommerce_nwp_settings' );
        $available_methods = $this->get_available_payment_methods( $nwp_settings );
        
        // æ ¹æ“šå€å¡Šè¨­å®šç¯©é¸è¦é¡¯ç¤ºçš„æ–¹å¼
        $show_methods = $attributes['showMethods'] ?? array();
        $filtered_methods = $this->filter_methods( $available_methods, $show_methods );
        
        // ç”Ÿæˆ HTML è¼¸å‡º
        return $this->generate_payment_methods_html( $filtered_methods, $attributes );
    }
    
    private function get_available_payment_methods( $settings ) {
        // åˆ©ç”¨ç¾æœ‰çš„è¨­å®šé‚è¼¯åˆ¤æ–·å¯ç”¨ä»˜æ¬¾æ–¹å¼
        $methods = array();
        
        if ( $settings['credit'] === 'yes' ) {
            $methods['credit'] = array(
                'name' => __( 'ä¿¡ç”¨å¡', 'newebpay-payment' ),
                'description' => __( 'æ”¯æ´å„å¤§éŠ€è¡Œä¿¡ç”¨å¡', 'newebpay-payment' ),
                'icon' => 'credit-card'
            );
        }
        
        // å…¶ä»–ä»˜æ¬¾æ–¹å¼...
        
        return $methods;
    }
}
```

### èˆ‡ nwpElectronicInvoice.php æ•´åˆ
```php
/**
 * é›»å­ç™¼ç¥¨å€å¡Šæ•´åˆ
 */
class Newebpay_Invoice_Block {
    
    public function render_callback( $attributes, $content ) {
        // æª¢æŸ¥é›»å­ç™¼ç¥¨åŠŸèƒ½æ˜¯å¦å•Ÿç”¨
        if ( ! $this->is_invoice_enabled() ) {
            return '';
        }
        
        // å–å¾—ç™¼ç¥¨è¨­å®š
        $invoice_instance = nwpElectronicInvoice::get_instance();
        $invoice_settings = $invoice_instance->get_settings();
        
        // æ ¹æ“šä½¿ç”¨è€…ç‹€æ…‹é¡¯ç¤ºä¸åŒå…§å®¹
        if ( is_user_logged_in() ) {
            return $this->render_invoice_form( $attributes, $invoice_settings );
        } else {
            return $this->render_login_prompt( $attributes );
        }
    }
}
```

## ğŸ¨ æ¨£å¼ç³»çµ±è¦ç¯„

### CSS æ¶æ§‹
```css
/* å€å¡Šå‘½åç©ºé–“ */
.wp-block-newebpay-payment-methods {
    /* åŸºç¤å€å¡Šæ¨£å¼ */
}

/* ä½ˆå±€è®Šé«” */
.wp-block-newebpay-payment-methods.is-layout-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.wp-block-newebpay-payment-methods.is-layout-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

/* ä»˜æ¬¾æ–¹å¼é …ç›® */
.newebpay-payment-method {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.newebpay-payment-method:hover {
    border-color: #007cba;
    box-shadow: 0 2px 8px rgba(0, 124, 186, 0.1);
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .wp-block-newebpay-payment-methods.is-layout-grid {
        grid-template-columns: 1fr;
    }
}
```

### ä¸»é¡Œç›¸å®¹æ€§
```css
/* é©æ‡‰ä¸åŒä¸»é¡Œçš„è®Šæ•¸ */
.wp-block-newebpay-payment-methods {
    --newebpay-primary-color: var(--wp--preset--color--primary, #007cba);
    --newebpay-secondary-color: var(--wp--preset--color--secondary, #666);
    --newebpay-border-radius: var(--wp--preset--border-radius--medium, 4px);
}
```

## ğŸ“¡ API æ•´åˆè¦ç¯„

### REST API ç«¯é»
```php
/**
 * è¨»å†Šè‡ªå®šç¾© REST API ç«¯é»
 */
class Newebpay_Blocks_API {
    
    public function register_routes() {
        register_rest_route( 'newebpay/v1', '/payment-methods', array(
            'methods' => 'GET',
            'callback' => array( $this, 'get_payment_methods' ),
            'permission_callback' => array( $this, 'check_permissions' )
        ) );
        
        register_rest_route( 'newebpay/v1', '/payment-status/(?P<order_id>\d+)', array(
            'methods' => 'GET',
            'callback' => array( $this, 'get_payment_status' ),
            'permission_callback' => array( $this, 'check_order_permissions' )
        ) );
    }
    
    public function get_payment_methods( $request ) {
        // å›å‚³å¯ç”¨çš„ä»˜æ¬¾æ–¹å¼
        $methods = $this->get_available_methods();
        return new WP_REST_Response( $methods, 200 );
    }
}
```

### AJAX è™•ç†
```javascript
// å‰ç«¯ AJAX è«‹æ±‚ç¯„ä¾‹
const fetchPaymentMethods = async () => {
    try {
        const response = await fetch('/wp-json/newebpay/v1/payment-methods', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-WP-Nonce': newebpayBlocks.nonce
            }
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Error fetching payment methods:', error);
        return [];
    }
};
```

## ğŸ§ª æ¸¬è©¦è¦ç¯„

### å–®å…ƒæ¸¬è©¦çµæ§‹
```php
/**
 * å€å¡ŠåŠŸèƒ½æ¸¬è©¦é¡åˆ¥
 */
class Test_Newebpay_Blocks extends WP_UnitTestCase {
    
    public function setUp() {
        parent::setUp();
        $this->blocks_instance = Newebpay_Blocks::get_instance();
    }
    
    public function test_blocks_registration() {
        // æ¸¬è©¦å€å¡Šè¨»å†Š
        $this->assertTrue( $this->blocks_instance->is_block_registered( 'newebpay/payment-methods' ) );
    }
    
    public function test_payment_methods_rendering() {
        // æ¸¬è©¦ä»˜æ¬¾æ–¹å¼å€å¡Šæ¸²æŸ“
        $attributes = array( 'showMethods' => array( 'credit', 'atm' ) );
        $output = $this->blocks_instance->render_payment_methods( $attributes );
        
        $this->assertContains( 'credit', $output );
        $this->assertContains( 'atm', $output );
    }
}
```

### å‰ç«¯æ¸¬è©¦
```javascript
// Jest æ¸¬è©¦ç¯„ä¾‹
import { render, screen } from '@testing-library/react';
import PaymentMethodsEdit from '../payment-methods/edit';

describe('PaymentMethodsEdit', () => {
    it('renders payment methods correctly', () => {
        const attributes = {
            showMethods: ['credit', 'atm'],
            layout: 'grid'
        };
        
        render(<PaymentMethodsEdit attributes={attributes} setAttributes={jest.fn()} />);
        
        expect(screen.getByText('ä¿¡ç”¨å¡')).toBeInTheDocument();
        expect(screen.getByText('ATM')).toBeInTheDocument();
    });
});
```

## ğŸ”’ å®‰å…¨æ€§è¦ç¯„

### è¼¸å…¥é©—è­‰
```php
/**
 * å€å¡Šå±¬æ€§é©—è­‰
 */
class Newebpay_Blocks_Validator {
    
    public function validate_payment_methods_attributes( $attributes ) {
        $validated = array();
        
        // é©—è­‰ showMethods
        if ( isset( $attributes['showMethods'] ) && is_array( $attributes['showMethods'] ) ) {
            $allowed_methods = $this->get_allowed_payment_methods();
            $validated['showMethods'] = array_intersect( $attributes['showMethods'], $allowed_methods );
        }
        
        // é©—è­‰ layout
        if ( isset( $attributes['layout'] ) ) {
            $allowed_layouts = array( 'grid', 'list', 'inline' );
            $validated['layout'] = in_array( $attributes['layout'], $allowed_layouts ) 
                ? $attributes['layout'] 
                : 'grid';
        }
        
        return $validated;
    }
}
```

### æ¬Šé™æ§åˆ¶
```php
/**
 * å€å¡Šæ¬Šé™æª¢æŸ¥
 */
public function check_block_permissions( $block_name ) {
    // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æœ‰ä½¿ç”¨å€å¡Šçš„æ¬Šé™
    if ( ! current_user_can( 'edit_posts' ) ) {
        return false;
    }
    
    // ç‰¹å®šå€å¡Šçš„é¡å¤–æ¬Šé™æª¢æŸ¥
    switch ( $block_name ) {
        case 'newebpay/payment-methods':
            return current_user_can( 'manage_woocommerce' );
        case 'newebpay/transaction-history':
            return is_user_logged_in();
        default:
            return true;
    }
}
```

## ğŸ“Š æ•ˆèƒ½å„ªåŒ–è¦ç¯„

### è³‡æºè¼‰å…¥ç­–ç•¥
```php
/**
 * æ¢ä»¶å¼è³‡æºè¼‰å…¥
 */
public function enqueue_block_assets() {
    // åªåœ¨æœ‰ä½¿ç”¨å€å¡Šçš„é é¢è¼‰å…¥è³‡æº
    if ( has_block( 'newebpay/payment-methods' ) ) {
        wp_enqueue_script( 'newebpay-payment-methods' );
        wp_enqueue_style( 'newebpay-payment-methods' );
    }
    
    if ( has_block( 'newebpay/payment-status' ) ) {
        wp_enqueue_script( 'newebpay-payment-status' );
    }
}
```

### å¿«å–æ©Ÿåˆ¶
```php
/**
 * å€å¡Šè¼¸å‡ºå¿«å–
 */
public function render_with_cache( $attributes, $content, $block ) {
    $cache_key = 'newebpay_block_' . md5( serialize( $attributes ) );
    $cached_output = wp_cache_get( $cache_key, 'newebpay_blocks' );
    
    if ( false === $cached_output ) {
        $cached_output = $this->render_block_content( $attributes, $content, $block );
        wp_cache_set( $cache_key, $cached_output, 'newebpay_blocks', HOUR_IN_SECONDS );
    }
    
    return $cached_output;
}
```

---

**æ–‡ä»¶ç‹€æ…‹**: ğŸ“‹ æŠ€è¡“è¦ç¯„å®Œæˆ  
**é©ç”¨ç‰ˆæœ¬**: v1.0.10  
**æœ€å¾Œæ›´æ–°**: 2025å¹´8æœˆ30æ—¥
