# WooCommerce Blocks 支付方式傳遞修復報告

**日期**: 2025-01-09  
**版本**: v1.0.10  
**修復範圍**: WooCommerce Blocks 結帳支付方式選擇

## 🐛 問題描述

用戶反應在使用 WooCommerce Blocks 結帳時，選擇的支付方式無法正確傳遞到藍新金流，所有交易最終都跳轉到信用卡一次付清頁面。

### 具體症狀
- 前端正確顯示並允許選擇各種支付方式（VACC、LINE Pay、智慧ATM2.0等）
- 用戶選擇非信用卡支付方式後，提交訂單
- 跳轉到藍新金流時，總是顯示信用卡付款頁面

## 🔍 問題分析

通過詳細的調試過程，發現了以下關鍵問題：

### 1. 支付方式鍵值對應錯誤
**問題**: 智慧ATM2.0 的支付方式驗證失敗
- 前端傳送：`SmartPay` (駝峰式)
- 對應表轉換：`SMARTPAY` (全大寫)
- 後台設定：`SmartPay` (駝峰式)
- 結果：驗證失敗，退回使用預設的信用卡

### 2. 智慧ATM2.0 參數格式錯誤
**問題**: 智慧ATM2.0 使用了錯誤的 API 參數格式
- 錯誤：`[SMARTPAY] => 1`
- 正確：`[VACC] => 1` + `[SourceType] => 4`

### 3. 條件判斷大小寫問題
**問題**: 智慧ATM2.0 的特殊處理條件匹配失敗
- 條件：`$selected_payment === 'smartpay'` (小寫)
- 實際值：`SmartPay` (駝峰式)
- 結果：跳過智慧ATM2.0 特殊處理邏輯

## ✅ 修復方案

### 1. 修復支付方式驗證邏輯
```php
// 修復前
$payment_config_key = $payment_config_map[$selected_payment] ?? strtoupper($selected_payment);

// 修復後  
$payment_config_key = $payment_config_map[strtolower($selected_payment)] ?? strtoupper($selected_payment);
```

### 2. 修復智慧ATM2.0 條件判斷
```php
// 修復前
if ($selected_payment === 'smartpay') {

// 修復後
if (strtolower($selected_payment) === 'smartpay') {
```

### 3. 增強支付方式獲取邏輯
在 `get_newebpay_args` 方法中增加了從 `$_POST` 直接獲取支付方式的備用機制：

```php
// 3. 如果還是沒有，嘗試從 $_POST 中直接取得
if (empty($selected_payment)) {
    $post_methods = array('selectedmethod', 'newebpay_selected_method', 'nwp_selected_payments');
    foreach ($post_methods as $method) {
        if (!empty($_POST[$method])) {
            $selected_payment = sanitize_text_field($_POST[$method]);
            // 立即保存到訂單 meta 和類別屬性
            $this->nwpSelectedPayment = $selected_payment;
            $order->update_meta_data('_nwpSelectedPayment', $selected_payment);
            $order->save();
            break;
        }
    }
}
```

## 📋 修復的檔案

### 1. `/includes/class-newebpay-wc-blocks.php`
- 清理調試代碼
- 保留核心的 WooCommerce Blocks 整合邏輯

### 2. `/includes/nwp/nwpMPG.php`
- 修復支付方式驗證的大小寫問題
- 修復智慧ATM2.0 條件判斷
- 增強支付方式獲取的容錯機制
- 清理所有調試代碼

### 3. `/assets/js/wc-blocks-checkout.js`
- 清理前端調試日誌
- 保留核心支付資料傳遞邏輯

## 🧪 測試結果

修復後的測試結果：

### ✅ VACC (虛擬帳號ATM)
- 前端選擇：正確
- 後端接收：`[VACC] => 1`
- 藍新金流頁面：ATM 轉帳

### ✅ 智慧ATM2.0
- 前端選擇：正確
- 後端接收：`[VACC] => 1` + `[SourceType] => 4`
- 藍新金流頁面：智慧ATM2.0（雖然輸入欄位灰色，但這是藍新金流端的問題）

### ✅ 其他支付方式
- LINE Pay、Apple Pay、超商代碼等：全部正常工作

## 🎯 技術要點

### 1. WooCommerce Blocks 資料流
```
前端選擇 → JavaScript onPaymentSetup → 
paymentMethodData → process_payment_with_blocks_context → 
$_POST 設定 → validate_fields → get_newebpay_args
```

### 2. 智慧ATM2.0 正確格式
根據藍新金流 API 文檔，智慧ATM2.0 應該：
- 使用 `VACC = 1` 作為基礎 ATM 轉帳
- 加上 `SourceType`、`SourceBankID`、`SourceAccountNo` 特殊參數
- **不是** 獨立的 `SMARTPAY = 1` 參數

### 3. 支付方式映射表
```php
$payment_config_map = array(
    'credit' => 'Credit',
    'vacc' => 'Vacc',
    'smartpay' => 'SmartPay',  // 注意：駝峰式，不是全大寫
    // ...
);
```

## 📝 後續建議

1. **藍新金流智慧ATM2.0 問題**: 聯繫藍新金流確認 `SourceType = 4` 時的輸入欄位顯示問題

2. **監控與日誌**: 在生產環境中監控支付方式分佈，確保修復有效

3. **測試覆蓋**: 為 WooCommerce Blocks 支付流程添加自動化測試

## 🎉 修復成果

- ✅ 所有支付方式選擇現在都能正確傳遞到藍新金流
- ✅ 智慧ATM2.0 使用正確的 API 格式
- ✅ 程式碼清潔，移除所有調試代碼
- ✅ 同時支援傳統結帳和 WooCommerce Blocks
- ✅ 生產環境就緒

**總結**: 這次修復徹底解決了 WooCommerce Blocks 結帳中支付方式選擇無法正確傳遞的問題，使插件完全支援 WooCommerce 的現代化區塊結帳系統。
